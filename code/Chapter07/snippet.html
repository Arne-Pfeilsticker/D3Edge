 <pre><code style="display: block; padding: 0.5em; background-color: #f4f4f4; font-size: 0.75em; color: black;"><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">001:</span><span class="comment" style="color: #777;">//Define&nbsp;the&nbsp;namespace&nbsp;for&nbsp;our&nbsp;API.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">002:</span><span class="keyword" style="font-weight: bold; color: navy;">var</span>&nbsp;d3Edge&nbsp;=&nbsp;{};<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">003:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">004:</span><span class="comment" style="color: #777;">//Define&nbsp;our&nbsp;data&nbsp;manager&nbsp;module.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">005:</span>d3Edge.dataManager&nbsp;=&nbsp;<span class="function"><span class="keyword" style="font-weight: bold; color: navy;">function</span>&nbsp;<span class="func-title">module</span><span class="params">()</span>&nbsp;{</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">006:</span>&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">var</span>&nbsp;exports&nbsp;=&nbsp;{},<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">007:</span>&nbsp;&nbsp;&nbsp;&nbsp;dispatch&nbsp;=&nbsp;d3.dispatch(<span class="string" style="color: #050;">'geoReady'</span>,&nbsp;<span class="string" style="color: #050;">'dataReady'</span>,&nbsp;<span class="string" style="color: #050;">'dataLoading'</span>),<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">008:</span>&nbsp;&nbsp;&nbsp;&nbsp;data;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">009:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">010:</span>&nbsp;&nbsp;<span class="comment" style="color: #777;">//Create&nbsp;a&nbsp;method&nbsp;to&nbsp;load&nbsp;the&nbsp;csv&nbsp;file,&nbsp;and&nbsp;apply&nbsp;cleaning&nbsp;function&nbsp;asynchronously.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">011:</span>&nbsp;&nbsp;exports.loadCsvData&nbsp;=&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">function</span>(_file,&nbsp;_cleaningFunc)&nbsp;{<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">012:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">013:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" style="color: #777;">//Create&nbsp;the&nbsp;csv&nbsp;request&nbsp;using&nbsp;d3.csv.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">014:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">var</span>&nbsp;loadCsv&nbsp;=&nbsp;d3.csv(_file);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">015:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">016:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" style="color: #777;">//On&nbsp;the&nbsp;progress&nbsp;event,&nbsp;dispatch&nbsp;the&nbsp;custom&nbsp;dataLoading&nbsp;event.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">017:</span>&nbsp;&nbsp;&nbsp;&nbsp;loadCsv.on(<span class="string" style="color: #050;">'progress'</span>,&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">function</span>()&nbsp;{&nbsp;dispatch.dataLoading(d3.event.loaded);});<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">018:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">019:</span>&nbsp;&nbsp;&nbsp;&nbsp;loadCsv.get(<span class="function"><span class="keyword" style="font-weight: bold; color: navy;">function</span>&nbsp;<span class="params">(_err,&nbsp;_response)</span>&nbsp;{</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">020:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" style="color: #777;">//Apply&nbsp;the&nbsp;cleaning&nbsp;function&nbsp;supplied&nbsp;in&nbsp;the&nbsp;_cleaningFunc&nbsp;parameter.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">021:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_response.forEach(<span class="function"><span class="keyword" style="font-weight: bold; color: navy;">function</span>&nbsp;<span class="params">(d)</span>&nbsp;{</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">022:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_cleaningFunc(d);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">023:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">024:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" style="color: #777;">//Assign&nbsp;the&nbsp;cleaned&nbsp;response&nbsp;to&nbsp;our&nbsp;data&nbsp;variable.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">025:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;_response;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">026:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">027:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" style="color: #777;">//Dispatch&nbsp;our&nbsp;custom&nbsp;dataReady&nbsp;event&nbsp;passing&nbsp;in&nbsp;the&nbsp;cleaned&nbsp;data.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">028:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dispatch.dataReady(_response);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">029:</span>&nbsp;&nbsp;&nbsp;&nbsp;});<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">030:</span>&nbsp;&nbsp;};<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">031:</span>&nbsp;&nbsp;<span class="comment" style="color: #777;">//Create&nbsp;a&nbsp;method&nbsp;to&nbsp;access&nbsp;the&nbsp;cleaned&nbsp;data.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">032:</span>&nbsp;&nbsp;exports.getCleanedData&nbsp;=&nbsp;<span class="function"><span class="keyword" style="font-weight: bold; color: navy;">function</span>&nbsp;<span class="params">()</span>&nbsp;{</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">033:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">return</span>&nbsp;data;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">034:</span>&nbsp;&nbsp;};<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">035:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">036:</span>&nbsp;&nbsp;<span class="comment" style="color: #777;">//Create&nbsp;a&nbsp;method&nbsp;to&nbsp;load&nbsp;the&nbsp;geojson&nbsp;file,&nbsp;and&nbsp;execute&nbsp;a&nbsp;custom&nbsp;callback&nbsp;on&nbsp;response.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">037:</span>&nbsp;&nbsp;exports.loadGeoJson&nbsp;=&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">function</span>(_file,&nbsp;_callback)&nbsp;{<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">038:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" style="color: #777;">//Load&nbsp;json&nbsp;file&nbsp;using&nbsp;d3.json.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">039:</span>&nbsp;&nbsp;&nbsp;&nbsp;d3.json(_file,&nbsp;<span class="function"><span class="keyword" style="font-weight: bold; color: navy;">function</span>&nbsp;<span class="params">(_err,&nbsp;_data)</span>&nbsp;{</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">040:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" style="color: #777;">//Execute&nbsp;the&nbsp;callback,&nbsp;assign&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;context.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">041:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_callback(_data);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">042:</span>&nbsp;&nbsp;&nbsp;&nbsp;});<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">043:</span>&nbsp;&nbsp;};<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">044:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">045:</span>&nbsp;&nbsp;d3.rebind(exports,&nbsp;dispatch,&nbsp;<span class="string" style="color: #050;">'on'</span>);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">046:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">047:</span>&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">return</span>&nbsp;exports;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">048:</span>};<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">049:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">050:</span><span class="comment" style="color: #777;">//Instantiate&nbsp;our&nbsp;data&nbsp;manager&nbsp;module&nbsp;for&nbsp;each&nbsp;city.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">051:</span><span class="keyword" style="font-weight: bold; color: navy;">var</span>&nbsp;sanFranciscoDataManager&nbsp;=&nbsp;d3Edge.dataManager(),<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">052:</span>&nbsp;&nbsp;&nbsp;&nbsp;zurichDataManager&nbsp;=&nbsp;d3Edge.dataManager(),<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">053:</span>&nbsp;&nbsp;&nbsp;&nbsp;genevaDataManager&nbsp;=&nbsp;d3Edge.dataManager();<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">054:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">055:</span><span class="comment" style="color: #777;">//Load&nbsp;our&nbsp;Zurich&nbsp;data,&nbsp;and&nbsp;supply&nbsp;the&nbsp;cleaning&nbsp;function.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">056:</span>zurichDataManager.loadCsvData(<span class="string" style="color: #050;">'../../../data/zurich/zurich_delay.csv'</span>,&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">function</span>(d){<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">057:</span>&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">var</span>&nbsp;timeFormat&nbsp;=&nbsp;d3.time.format(<span class="string" style="color: #050;">'%Y-%m-%d&nbsp;%H:%M:%S&nbsp;%p'</span>);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">058:</span>&nbsp;&nbsp;d.DELAY&nbsp;=&nbsp;+d.DELAY_MIN;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">059:</span>&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">delete</span>&nbsp;d.DELAY_MIN;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">060:</span>&nbsp;&nbsp;d.SCHEDULED&nbsp;=&nbsp;timeFormat.parse(d.SCHEDULED);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">061:</span>&nbsp;&nbsp;d.LATITUDE&nbsp;=&nbsp;+d.LATITUDE;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">062:</span>&nbsp;&nbsp;d.LONGITUDE&nbsp;=&nbsp;+d.LONGITUDE;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">063:</span>&nbsp;&nbsp;d.LOCATION&nbsp;=&nbsp;[d.LONGITUDE,&nbsp;d.LATITUDE];<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">064:</span>});<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">065:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">066:</span><span class="comment" style="color: #777;">//Load&nbsp;our&nbsp;Geneva&nbsp;data,&nbsp;and&nbsp;supply&nbsp;the&nbsp;cleaning&nbsp;function.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">067:</span>genevaDataManager.loadCsvData(<span class="string" style="color: #050;">'../../../data/geneva/geneva_delay_coord.csv'</span>,&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">function</span>(d){<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">068:</span>&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">var</span>&nbsp;timeFormat&nbsp;=&nbsp;d3.time.format(<span class="string" style="color: #050;">'%Y-%m-%d&nbsp;%H:%M:%S&nbsp;%p'</span>);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">069:</span>&nbsp;&nbsp;d.DELAY&nbsp;=&nbsp;+d.DELAY;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">070:</span>&nbsp;&nbsp;d.SCHEDULED&nbsp;=&nbsp;timeFormat.parse(d.SCHEDULED);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">071:</span>&nbsp;&nbsp;d.LATITUDE&nbsp;=&nbsp;+d.LATITUDE;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">072:</span>&nbsp;&nbsp;d.LONGITUDE&nbsp;=&nbsp;+d.LONGITUDE;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">073:</span>&nbsp;&nbsp;d.LOCATION&nbsp;=&nbsp;[d.LONGITUDE,&nbsp;d.LATITUDE];<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">074:</span>});<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">075:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">076:</span><span class="comment" style="color: #777;">//Load&nbsp;our&nbsp;San&nbsp;Francisco&nbsp;data,&nbsp;and&nbsp;supply&nbsp;the&nbsp;cleaning&nbsp;function.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">077:</span>sanFranciscoDataManager.loadCsvData(<span class="string" style="color: #050;">'../../../data/san_francisco/san_francisco_delay.csv'</span>,&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">function</span>(d){<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">078:</span>&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">var</span>&nbsp;timeFormat&nbsp;=&nbsp;d3.time.format(<span class="string" style="color: #050;">'%Y-%m-%d&nbsp;%H:%M:%S&nbsp;%p'</span>);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">079:</span>&nbsp;&nbsp;d.DELAY&nbsp;=&nbsp;+d.DELAY_MIN;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">080:</span>&nbsp;&nbsp;<span class="keyword" style="font-weight: bold; color: navy;">delete</span>&nbsp;d.DELAY_MIN;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">081:</span>&nbsp;&nbsp;d.SCHEDULED&nbsp;=&nbsp;timeFormat.parse(d.SCHEDULED);<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">082:</span>&nbsp;&nbsp;d.LATITUDE&nbsp;=&nbsp;+d.LATITUDE;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">083:</span>&nbsp;&nbsp;d.LONGITUDE&nbsp;=&nbsp;+d.LONGITUDE;<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">084:</span>&nbsp;&nbsp;d.LOCATION&nbsp;=&nbsp;[d.LONGITUDE,&nbsp;d.LATITUDE];<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">085:</span>});<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">086:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">087:</span><span class="comment" style="color: #777;">//Load&nbsp;the&nbsp;routes&nbsp;data&nbsp;and&nbsp;pass&nbsp;our&nbsp;drawRoutes&nbsp;method&nbsp;as&nbsp;the&nbsp;callback&nbsp;to&nbsp;be&nbsp;executed&nbsp;once&nbsp;the&nbsp;data&nbsp;loads.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">088:</span>zurichDataManager.loadGeoJson(<span class="string" style="color: #050;">'../../../data/zurich/routes_topo.json'</span>,&nbsp;<span class="function"><span class="keyword" style="font-weight: bold; color: navy;">function</span>&nbsp;<span class="params">(data)</span>&nbsp;{</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">089:</span>&nbsp;&nbsp;<span class="comment" style="color: #777;">//Do&nbsp;something&nbsp;with&nbsp;the&nbsp;data&nbsp;via&nbsp;a&nbsp;callback.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">090:</span>});<br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">091:</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">092:</span><span class="comment" style="color: #777;">//Load&nbsp;the&nbsp;stops&nbsp;data&nbsp;and&nbsp;pass&nbsp;our&nbsp;drawStops&nbsp;method&nbsp;as&nbsp;the&nbsp;callback&nbsp;to&nbsp;be&nbsp;executed&nbsp;once&nbsp;the&nbsp;data&nbsp;loads.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">093:</span>zurichDataManager.loadGeoJson(<span class="string" style="color: #050;">'../../../data/zurich/stops_geo.json'</span>,&nbsp;<span class="function"><span class="keyword" style="font-weight: bold; color: navy;">function</span>&nbsp;<span class="params">(data)</span>&nbsp;{</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">094:</span>&nbsp;&nbsp;<span class="comment" style="color: #777;">//Do&nbsp;something&nbsp;with&nbsp;the&nbsp;data&nbsp;via&nbsp;a&nbsp;callback.</span><br /><span class="linenumbering" style="color: #ccc; padding-right: 0.5em;">095:</span>});</code></pre>
